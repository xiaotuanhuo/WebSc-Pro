<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>用户编辑</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi"/>
    <link rel="shortcut icon" type="image/x-icon" th:href="@{/favicon.ico}"/>
    <link rel="stylesheet" th:href="@{/lib/layui/css/layui.css}">
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/animate.min.css}">
    <link rel="stylesheet" th:href="@{/lib/layui/extend/dtree.css}" />
</head>

<body>
	<div class="z-body animated fadeIn">
		<span id="currentUserProvince" style="display: none;"><shiro:principal property="province"/></span>
		<span id="currentUserCity" style="display: none;"><shiro:principal property="city"/></span>
		<span id="currentUserArea" style="display: none;"><shiro:principal property="area"/></span>
		<span id="currentRoleId" style="display: none;"><shiro:principal property="roleId"/></span>
		<span id="currentRoleTypeId" style="display: none;"><shiro:principal property="roleTypeId"/></span>
		<form action="" method="post" class="layui-form layui-form-pane">
			<div class="layui-form-item">
				<label for="loginName" class="layui-form-label">登陆名</label>
				<div class="layui-input-block">
					<input type="text" id="loginName" name="loginName"
						th:value="${user?.loginName}" lay-verify="required"
						lay-vertype="tips" autocomplete="off" class="layui-input">
				</div>
			</div>
			<div class="layui-form-item">
				<!-- 编辑时不显示密码框 -->
				<div th:if="${user == null}" class="layui-form-item">
					<label for="loginPwd" class="layui-form-label">密码</label>
					<div class="layui-input-block">
						<input type="loginPwd" id="loginPwd" name="loginPwd"
							lay-verify="required" lay-vertype="tips" autocomplete="off"
							class="layui-input">
					</div>
				</div>
			</div>
			<div class="layui-form-item">
				<label for="userName" class="layui-form-label">姓名</label>
				<div class="layui-input-block">
					<input type="text" id="userName" name="userName"
						th:value="${user?.userName}" lay-verify="required"
						lay-vertype="tips" autocomplete="off" class="layui-input">
				</div>
			</div>
			<div class="layui-form-item">
				<label for="sex" class="layui-form-label">性别</label>
				<div class="layui-input-block">
					<input type="radio" id="sex_0" name="sex" value="0" title="男" checked>
					<input type="radio" id="sex_1" name="sex" value="1" title="女">
				</div>
			</div>
			<div class="layui-form-item">
				<label for="age" class="layui-form-label">年龄</label>
				<div class="layui-input-block">
					<input type="text" id="age" name="age" th:value="${user?.age}"
						lay-verify="required" lay-vertype="tips" autocomplete="off"
						class="layui-input">
				</div>
			</div>
			<div class="layui-form-item">
				<label for="phone" class="layui-form-label">手机号</label>
				<div class="layui-input-block">
					<input type="text" id="phone" name="phone"
						th:value="${user?.phone}" lay-verify="phone" lay-vertype="tips"
						autocomplete="off" class="layui-input">
				</div>
			</div>
			<div class="layui-form-item">
				<label for="email" class="layui-form-label">邮箱</label>
				<div class="layui-input-block">
					<input type="text" id="email" name="email"
						th:value="${user?.email}" lay-verify="email" lay-vertype="tips"
						autocomplete="off" class="layui-input">
				</div>
			</div>
			<div class="layui-form-item">
				<label for="role" class="layui-form-label">角色</label>
				<div class="layui-input-block">
					<div id="role" class="xm-select-demo"></div>
				</div>
			</div>
			<div id="organziation" class="layui-form-item" style="display: none;">
				<label for="orgTree" class="layui-form-label">机构</label>
				<div class="layui-input-block">
					<ul id="orgTree" class="dtree" data-id="0" data-value="请选择机构"></ul>
				</div>
			</div>
			<div id="patientDiv" class="layui-form-item" style = "display: none;">
				<label for="patientType" class="layui-form-label">病人类型</label>
				<div class="layui-input-block">
					<div id="patientType" class="xm-select-demo"></div>
				</div>
			</div>
			<div id="operationDiv" class="layui-form-item" style = "display: none;">
				<label for="operationType" class="layui-form-label">手术类型</label>
				<div class="layui-input-block">
					<div id="operationType" class="xm-select-demo"></div>
				</div>
			</div>
			
			<div class="layui-form-item">
				<div class="layui-input-block"
					style="margin-left: 0; text-align: center;">
					<input type="hidden" id="userId" name="userId" th:value="${user?.userId}">
					<input type="hidden" id="roleId" name="roleId" th:value="${user?.roleId}">
					<input type="hidden" id="roleTypeId" name="roleTypeId" th:value="${user?.roleTypeId}">
					<input type="hidden" id="patients" name="patients" th:value="${user?.patientType}">
					<input type="hidden" id="operations" name="operations" th:value="${user?.operationType}">
					<input type="hidden" id="province" name="province" th:value="${user?.province}">
					<input type="hidden" id="city" name="city" th:value="${user?.city}">
					<input type="hidden" id="area" name="area" th:value="${user?.area}">
					<button th:text="${user}?'修改':'增加'"
						class="layui-btn layui-btn-normal btn-w100" lay-submit=""
						data-th-lay-filter="${user}?'edit':'add'"></button>
				</div>
			</div>
		</form>
	</div>
	
	<script th:src="@{/lib/jquery/jquery.min.js}"></script>
    <script th:src="@{/lib/layui/layui.js}"></script>
    <script th:src="@{/js/common.js}"></script>
    
    <script>
    	// 是否是第一次渲染，是：渲染；否：数据重载
    	var firstRender = true;
		var isEdit = $('#loginName').val() == '' ? false : true;	// 用于判断当前是新增还是编辑
		var patientArray;
		var operationArray;
		var defaultOrganization = "";
		if (isEdit) {
			var patients = $('#patients').val();
			var operations = $('#operations').val();
			patientArray = patients.split(',');
			operationArray = operations.split(',');
			defaultOrganization = $('#roleTypeId').val();
		}
		layui.config({
			base: '/lib/layui/extend/'
		}).extend({
			xmSelect: 'xm-Select'
		}).use(['form', 'layer', 'xmSelect', 'dtree'], function () {
			$ = layui.jquery;
			var form = layui.form,
				layer = layui.layer,
				xmSelect = layui.xmSelect,
				dtree = layui.dtree;
			var sex = [[${user?.sex} + '']];
			$("input[name='sex'][value='" + sex + "']").attr('checked',true);
			form.render();
			
			// 角色组件
			var roleKit = xmSelect.render({
				el: '#role',
				radio: true,
				clickClose: true,
				repeat: true,
				model: {
					label: {
						type: 'block',
						block: {
							//最大显示数量, 0:不限制
							showCount: 0,
							//是否显示删除图标
							showIcon: false
						}
					}
				},
				prop: {
					name: 'roleName',
					value: 'roleId'
				},
				initValue: isEdit ? [$('#roleId').val()] : null,
				on: function(data) {
					//arr:  当前已选中的数据
					var arr = data.arr;
					//change, 此次选择变化的数据,数组
					var change = data.change;
					//isAdd, 此次操作是新增还是删除
					var isAdd = data.isAdd;
					if (isAdd && arr.length != 0 && arr[0].roleId == 2) {
						// 选择医疗机构管理员角色时加载当前区划及下属医疗机构组织
						loadTree('/organization/tree');
						hideForDoctor();
					} else if (isAdd && arr.length != 0 && arr[0].roleId == 3) {
						// 选择卫监局角色时加载当前区划及下属卫监局组织
						loadTree('/bureau/tree');
						hideForDoctor();
					} else if (isAdd && arr.length != 0 && (arr[0].roleId == 4)) {
						// 选择区域管理员角色时加载当前区划下属医疗集团组织
						loadTree('/dept/subTree/' + $('#currentRoleTypeId').text());
						hideForDoctor();
					} else if (isAdd && arr.length != 0 && arr[0].roleId == 5) {
						// 选择医生角色时加载当前用户所属组织及其下属组织
						loadTree('/dept/tree');
						showForDoctor();
					} else if (isAdd && arr.length != 0 && arr[0].roleId == 6) {
						// 选择护士角色时加载当前用户所属组织及其下属组织
						loadTree('/dept/tree');
						hideForDoctor();
					} else if (isAdd && arr.length != 0 && arr[0].roleId == 7) {
						// 选择超级管理员时加载医疗集团根节点
						loadTree('/dept/tree/root');
						hideForDoctor();
					} else if (isAdd && arr.length != 0 && arr[0].roleId == 8) {
						// 选择区域订单录入员角色时加载当前区划及其下属医疗机构组织
						loadTree('/dept/tree');
						hideForDoctor();
					} else if (isAdd && arr.length != 0 && arr[0].roleId == 9) {
						// 选择医疗机构订单录入员角色时加载当前用户区划及其下属医疗机构组织
						loadTree('/organization/tree');
						hideForDoctor();
					} else {
						$('#orgDiv').hide();
						hideForDoctor();
					}
				}
			});
			
			// 根据当前用户角色加载可操作角色列表
			$.ajax({
				url: '/role/list/' + $('#roleId').text(),
				type: 'GET',
				dataType: 'json',
				success:function(response) {
					var data = response.data;
					roleKit.update({
						data: data,
						autoRow: true
					})
				}
			});
			// 根据所选角色及当前用户的可操作范围加载机构树
			var loadTree = function(dataUrl) {
				if (firstRender) {
					dtree.renderSelect({
						elem: '#orgTree',
						url: dataUrl,
						method: 'GET',
						dataStyle: 'layuiStyle',
						width: '100%',
						ficon: ['1', '-1'],
						icon: ['-1', '2'],
						selectInitVal: defaultOrganization,
						menubar: true,
						record: true,
						response: {
							statusCode: 0,
							treeId: 'id',
							title: 'name',
							parentId: 'parentId'
		                }
					});
					firstRender = false;
					$('#organziation').show();
				} else {
					dtree.reload('orgTree', {
						url: dataUrl,
						method: 'GET'
					});
				}
			};
			
			dtree.on("node('orgTree')" ,function(obj) {
				if (obj.param.recordData.area != undefined && obj.param.recordData.area.length != undefined) {
					$('#area').val(obj.param.recordData.area);
				}
				if (obj.param.recordData.city != undefined && obj.param.recordData.city.length != undefined) {
					$('#city').val(obj.param.recordData.city);
				}
				if (obj.param.recordData.province != undefined && obj.param.recordData.province.length != undefined) {
					$('#province').val(obj.param.recordData.province);
				}
                $('#roleTypeId').val(obj.param.nodeId);
            });
			
			// 病人类型
			var patientKit = xmSelect.render({
				el: '#patientType',
				initValue: isEdit ? patientArray : null,
				data: [
					{name: '儿童', value: 1},
					{name: '青年', value: 2},
					{name: '老年', value: 3},
				]
			});
			
			// 手术类型
			var operationKit = xmSelect.render({
				el: '#operationType',
				initValue: isEdit ? operationArray : null,
				prop: {
					name: 'operationtypeName',
					value: 'operationtypeId'
				}
			});
			
			// 加载手术类型列表
			$.ajax({
				url: '/operation/list',
				type: 'GET',
				dataType: 'json',
				success:function(response) {
					var data = response.data;
					operationKit.update({
						data: data,
						autoRow: true
					})
				}
			});
			
			// 选择医生角色时显示的控件
			var showForDoctor = function() {
				$('#patientDiv').show();
				$('#operationDiv').show();
			};
			
			// 选择非医生角色时情况并隐藏控件
			var hideForDoctor = function() {
				patientKit.setValue([]);
				operationKit.setValue([]);
				$('#patientDiv').hide();
				$('#operationDiv').hide();
			}
			
			//监听提交
			form.on('submit(add)', function (form) {
				form.field.roleId = roleKit.getValue('valueStr');
				//form.field.roleTypeId = $('#roleTypeId').val();
				if (roleKit.getValue('valueStr') === '5') {	// 医生
					form.field.patientType = patientKit.getValue('valueStr');
					form.field.operationType = operationKit.getValue('valueStr');
				}
				$.post('/user', form.field, function (result) {
					handlerResult(result, addDone);
				});
				return false;
            });
			
			//监听提交
			form.on('submit(edit)', function (form) {
				form.field._method = 'PUT';
				form.field.roleId = roleKit.getValue('valueStr');
				$.post('/user', form.field, function (result) {
					handlerResult(result, editDone);
				});
				return false;
			});
			
			function addDone(data) {
				layer.msg('添加成功', {icon: 6});
            }
			
			function editDone(data) {
				layer.msg("修改成功", {icon: 6});
			}
        });
    </script>
</body>

</html>